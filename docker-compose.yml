#version: '3.8'

volumes:
  static_volume:
  logs_volume:

services:
  redis:
    image: redis
    command: redis-server --port 6381
    ports:
      - 6381:6381
    networks:
      - app-network

  api:
    build: .
    entrypoint: ["/bin/bash"]
    command: ["/app/entrypoint.sh"]
    env_file:
      - .env
    volumes:
      - static_volume:/app/staticfiles
      - logs_volume:/logs
      # Mount only essential directories for development
      - ./browser_use:/app/browser_use:delegated
      - ./bugowl:/app/bugowl:delegated
      - ./entrypoint.sh:/app/entrypoint.sh:delegated
      - ./.env:/app/.env:delegated
    ports:
      - 8020:8020
    links:
      - redis
    depends_on:
      - redis
    networks:
      - app-network
    user: root  # Run as root to avoid permission issues

  celery: 
    build: .
    command: bash -c "cd /app/bugowl && /app/.venv/bin/celery -A api.celery_app worker -l info"
    env_file:
      - .env
    volumes:
      - logs_volume:/logs
      # Mount only essential directories for development
      - ./browser_use:/app/browser_use:delegated
      - ./bugowl:/app/bugowl:delegated
      - ./.env:/app/.env:delegated
    links:
      - redis
    depends_on:
      - redis
    networks:
      - app-network

networks:
  app-network:
    external: false
    driver: bridge
